//
//  mpltestparsimony.c
//  Morphy
//
//  Created by Martin Brazeau on 28/01/2019.
//  Copyright Â© 2019 Martin Brazeau. All rights reserved.
//

#include "mpltest.h"
#include "testharddat.h"
#include "../src/Characters/mpl_matrix.h"
#include "../src/Characters/mpl_parsim.h"
#include "testutils.h"
#include "../src/Trees/mpl_tree.h"
#include "../src/Trees/mpl_topol.h"
#include "../src/Trees/mpl_newick_rdr.h"
#include "../src/Analysis/mpl_scoretree.h"
#include "testmplparsimony.h"

int test_basic_parsimony (void)
{
    theader("Test simple two-tip parsimony case");
    
    int failn = 0;
    
    long ntax = 2;
    long nchar = 10;
    
    char *rawmatrix =
    "0000000010\
     1111111111;";
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_apply_data(m);
    
    double len = 0.0;
    len = mpl_fitch_downpass(0, 1, 2, &m->parsets[0]);
    
    if (len != 9.0) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    
    return failn;
}

int test_parsimony_on_tree (void)
{
    theader("Test standard Fitch parsimony for a whole tree");
    
    int failn = 0;
    
    long ntax = 10;
    long nchar = 10;
    
    char *rawmatrix =
    "1010312231\
    2130233203\
    3001210203\
    2131111202\
    3302222312\
    2231202332\
    1023203131\
    1123103001\
    2222213220\
    3203321302;";
    
    char* newick = "((((1,((2,7),(5,9))),(4,8)),6),(3,10));";
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    mpl_node* n = NULL;
    
    long i = 0;
    double len = 0.0;
    
    for (i = 0; i < ntax - 1; ++i) {
        n = t->postord_intern[i];
        len += mpl_fitch_downpass
        (n->left->mem_index, n->right->mem_index, n->mem_index, &m->parsets[0]);
    }
    
    if (len != 53.0) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}


int test_fullpass_parsimony (void)
{
    theader("Test full-pass Fitch parsimony");
    
    int failn = 0;
    
    long ntax = 10;
    long nchar = 10;
    
    char *rawmatrix =
    "1010312231\
    2130233203\
    3001210203\
    2131111202\
    3302222312\
    2231202332\
    1023203131\
    1123103001\
    2222213220\
    3203321302;";
    
    char* newick = "((((1,((2,7),(5,9))),(4,8)),6),(3,10));";
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    len = mpl_fullpass_parsimony(t);
    
    if (len != 53.0) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}

int test_wagner_fullpass_parsimony (void)
{
    theader("Test full-pass Wagner parsimony");
    
    int failn = 0;
    
    long ntax = 10;
    long nchar = 10;
    
    char *rawmatrix =
    "1010312231\
     2130233203\
     3001210203\
     2131111202\
     3302222312\
     2231202332\
     1023203131\
     1123103001\
     2222213220\
     3203321302;";
    
    char* newick = "((((1,((2,7),(5,9))),(4,8)),6),(3,10));";
    int i = 0;
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    // Set all characters to type wagner:
    for (i = 0; i < nchar; ++i) {
        mpl_matrix_set_parsim_t(i, MPL_WAGNER_T, m);
    }
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    len = mpl_fullpass_parsimony(t);
    
    if (len != 68.0) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}

int test_fullpass_with_large_data_std_parsimony (void)
{
    theader("Test full-pass standard parsimony with large matrix");
    
    int failn = 0;
    
    long ntax = 28;
    long nchar = 95;
    
    char *rawmatrix =
    "0000000000 0000000000 000---0000 000-000000 0000000000 000-0-0000 0000000000 00000--000 0000000000 0000?\
    11-1012100 1120200001 001---0000 100-1--100 0100000110 1010320010 0000101000 01000--303 0000000000 0010?\
    ?????????? ?????????? ??30--0010 ??0-?????? ??1-?-??10 0?0-??1?-- ????0?00?? 10??1112?? ????100111 -0-1?\
    00??0????? ?????????? ??3111100? ?????????? ??011100?? 0???????11 ?1???????? 10?????2?? ????1?1-1? ?????\
    000?0????? ??11??0111 1030--???1 010-???0?? ??1---0-10 010-3?00-- ??010?000? ?0??111?1- ?0?111011? ???1?\
    11-1012010 11212?0001 002---0001 100-010100 1100000110 1010320010 0000101010 01000--103 1000000000 0000?\
    00?100(02)??? 01?1(23)0???1 0?0---00?0 0010002?00 1100000001 000-31-010 ????-?30?0 00000--01- 0???00?000 0100?\
    1011023111 112131???1 100---0000 00101--200 0100001010 00103011?0 1-1-010011 01010?-11- 10??00?0?0 0010?\
    ?????????? ???????0?? ??3000?10? 010-0100?0 1100-0--10 0011300?10 ????0????0 010110021- 1???100110 1000?\
    1011023110 1111311001 110---0000 000-1---00 0100001010 000-301110 1-1-013110 01010--11- 0010000000 00100\
    ?????????? ??????0??? ??3000?1?0 ??0-010?1? 1100100?10 0?11??0?00 ????0??0?0 00111002?? ????100110 10001\
    ?????????? ??????0001 ??3101?100 ????0????? ?100110010 0011??0?01 0100?????? 00??1002?? ??1?10???? ??001\
    ?????????? ??2????11? ????--???? ?????????? ??1-?-??1? ????????-- ?????0?00? 10?????2?? ???110011? ???10\
    11-11?301? 1111(23)?0010 002---0000 0011012101 1100000111 001011-010 ?0001?0110 00000--?02 1?00000000 01001\
    11-11?3001 2120000000 001---0000 0011002101 1100000101 000-11-000 0000100100 01000--101 110?000000 00000\
    0011012?10 11?12??011 002---0000 1010002?00 1100000?10 1010??1??0 ??001?10?0 0100??-??? 1??0?????? ?0000\
    1001??30?? 112???0010 01?---0000 000-1--201 1100000111 000-2?-010 0000102110 01000--002 1?00000000 00000\
    ?????????? ???????11? ??30--0010 010-?????? ?11-?-??10 010-3010-- 0001?00000 10?????2?? ????10011? ?0-10\
    0???0?1??1 ?0?1??00?? ??311111?? 010-0100?0 1100110010 0011??0?01 ??????0??0 0011???21- 101?1001(01)0 10001\
    00000?1011 1011300001 1030000100 010-010010 1100100010 001?300010 0000000001 0{01}1110021- 101110?101 -0001\
    0010000010 1011101000 110---0-00 0010011000 0100001010 0010301110 0?0?00?0?1 01010--11- 0?1?000000 00000\
    00000?1?1? ?0113?0001 1031111101 010-01?0?0 ??01110010 0?0-300001 0100?0?0?? 10?110(01)21- ?011111-10 10?11\
    ?00?????1? 1?213?01?1 ????--0011 ?????????? ??1-?-??10 010-??0?-- ??0??0000? ?0???????? ?????????? ????0\
    11-11?3??? 1?2???0000 00?---0000 0011011101 1100000111 001011-010 0000100110 00000--002 11??000000 01000\
    00?00000?0 1021100000 002---0000 10111--100 1000000110 1010320010 00001000?0 01000--100 10??00?000 00000\
    ?????????? ?????????? ??30--???? ?????????? ??1-?????0 ?????????? ??0????0?? ?????????? ?????????? ????0\
    ?????????? ???????1?1 ??3000?0?1 ????010??? ?1001???10 0011??0??0 00??0??0?0 00??11021- 1??1100111 -0001\
    ?????????? ?????????? ?????????? ?????????? ?100?????? ???????0?0 00??????0? 00?????21- ???1100111 ---1?;";
    
   
    
    char* newick =
    "(1,(7,(((25,(16,(2,6))),(15,(17,(14,24)))),((9,((11,(12,(19,((26,((3,(5,(23,(13,18)))),28)),(4,22))))),(20,27))),(21,(8,10))))));";
//    "(1,((((((2,6),(((14,24),17),15)),16),25),((((((((((3,18),5),26),(13,23)),28),27),20),((((4,22),19),12),11)),9),((8,10),21))),7));";
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_set_gap_handle(GAP_MISSING, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    mpl_tree_checker(t);
    
//    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    len = mpl_fullpass_parsimony(t);
    
    if (len != 212.0) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}

int test_fullpass_with_large_data_std_parsimony2 (void)
{
    theader("Test full-pass standard parsimony with large matrix II");
    
    int failn = 0;
    
    long ntax = Brazeau.ntax;
    long nchar = Brazeau.nchar;
    
    char *rawmatrix = Brazeau.chardat;
    
    char* newick =
    "(1,(2,(((8,(72,((95,((28,(45,((7,(((((((((((15,(39,(23,(76,(59,(38,(74,(60,(69,(9,(77,(68,(((63,(26,(33,(3,(31,(13,(40,(65,(54,(75,(49,(12,22)))))))))))),43),16))))))))))))),19),4),27),46),17),57),52),37),62),18)),(94,(((79,(50,(14,(((((((24,55),41),90),89),47),56),88)))),(73,(((30,35),((81,(34,64)),(80,(82,(83,(71,86)))))),((58,91),(87,(84,85)))))),(36,(93,(66,92)))))))),(48,(21,(25,(10,(20,42))))))),(29,((11,(5,70)),(51,53)))))),(32,44)),(78,(61,(6,67))))));";
//    "(1,((((((2,6),(((14,24),17),15)),16),25),((((((((((3,18),5),26),(13,23)),28),27),20),((((4,22),19),12),11)),9),((8,10),21))),7));";
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_set_gap_handle(GAP_MISSING, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    mpl_tree_checker(t);
    
//    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    len = mpl_fullpass_parsimony(t);
    
    if (len != 960.0) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}

int test_fullpass_with_inapplicables (void)
{
    theader("Test full-pass with inapplicable data");
    
    int failn = 0;
    
//    long ntax = 28;
//    long nchar = 95;

    long ntax = Miyashita.ntax;//95;
    long nchar = Miyashita.nchar;//284;
    char *rawmatrix = Miyashita.chardat;
    
    char* newick = "(1,(4,(2,(3,(5,(7,(8,(6,(11,((43,((((36,((9,((22,(10,(12,((13,(18,19)),(15,(14,(16,(17,20)))))))),(23,(21,(24,(25,((26,27),(30,(28,29))))))))),(31,(32,(35,(33,34)))))),(37,38)),((39,40),(41,42))),(47,(46,(48,(51,(52,(49,50)))))))),(44,45)))))))))));";
    //    "(1,(7,(((25,(16,(2,6))),(15,(17,(14,24)))),((9,((11,(12,(19,((26,((3,(5,(23,(13,18)))),28)),(4,22))))),(20,27))),(21,(8,10))))));";
//        "(1,(2,(((8,(72,((95,(21,(29,((28,((45,(71,((22,(((49,(((75,(31,((12,(13,(3,40))),(54,65)))),(26,33)),(43,63))),((68,(7,(62,77))),(46,(52,57)))),(18,(9,37)))),(69,((16,(27,(17,(4,19)))),((76,(38,(59,(15,23)))),(39,(60,74)))))))),((50,((14,(41,(79,(56,((47,(88,89)),(55,90)))))),(24,(73,((((30,35),(80,(82,(83,86)))),(81,(34,64))),((58,91),(87,(84,85)))))))),(94,((36,93),(66,92)))))),(48,(25,(10,(20,42)))))))),(53,(51,(70,(5,11))))))),(32,44)),((6,67),(61,78)))));";
    //    "(1,(2,(((((((((((((((((((3,40),13),(12,(54,65))),31),(43,63)),(26,33)),(22,75)),((((((((((((4,19),17),(((15,23),39),((38,59),76))),(60,74)),16),27),69),57),37),52),(((((7,77),62),18),68),(9,46))),49)),((((((14,(41,(((47,(88,89)),56),(55,90)))),79),(((((30,35),(((34,64),81),(80,(82,(83,86))))),73),((58,91),((84,85),87))),94)),(36,((66,92),93))),50),24)),45),71),28),((((10,((20,42),(21,29))),25),48),95)),72),((5,11),70)),(51,53)),8),(32,44)),(((6,67),78),61))));";
    //    "(1,(2,(((8,((72,(95,(((28,((((22,(75,((49,(((13,(3,40)),(31,(43,63))),(12,(54,65)))),(26,33)))),(((68,(18,(77,(7,62)))),(9,(27,46))),(37,(52,57)))),(69,((16,(17,((4,19),(60,74)))),((39,(15,23)),(76,(38,59)))))),(45,(71,(50,((24,((79,(14,(41,(((47,56),(88,89)),(55,90))))),(94,(36,(93,(66,92)))))),((73,(((30,35),(81,(34,64))),((58,91),(87,(84,85))))),(80,(82,(83,86)))))))))),(48,(25,(10,(20,42))))),(21,29)))),((70,(5,11)),(51,53)))),(32,44)),(61,(78,(6,67))))));";
    //    "(1,(2,(((((31,(12,(((13,(3,40)),((49,((37,(9,(46,(27,(69,((16,(17,((4,19),(60,74)))),(39,((15,23),(38,(59,76)))))))))),(52,57))),(43,63))),(54,65)))),(7,((18,68),(62,77)))),(33,(26,71))),(22,75)),((70,(5,11)),(8,(95,((32,(44,((6,67),(61,78)))),((48,(25,((10,(20,42)),(21,((29,72),(51,53)))))),((50,((79,(14,(41,(((47,56),(88,89)),(55,90))))),((73,((24,(((30,35),(34,64)),((58,91),(87,(84,85))))),(81,(80,(82,(83,86)))))),((93,(36,94)),(66,92))))),(28,45))))))))));";

    
   // "0-100--00-0---??10-00010010?3{0 1}1-100-00?-0-0{0 1}0-?--?0----?0---0----00---0--??0--------------??-00------------00----0?00000?0--0-000?-?-000--0-?-----0??00?-00----00-00?0000-0??-0??------------?--?0----?------0----???-?-?------0??-?-0????--------??-------------0---0-0-0?-?-??0-------?00-\
    0-000--1100?001000-0??01?010300-100-000-00000-?--?1----?0---0----00---0--??0--------------??-00------------00----0?000-000--0-000?-?-000--0-?-----0??00--00----00-00?0000-???-001-00-0{0 1}--000??--?0-1000-0-0-00--00?0{0 1}-0--0-----0?10??1???---------??-------------0---0-0-0--?????-------?00-\
    0-000--0121?001100-0011001010--01-10{0 1}??----0?-----10---00--2112--000--11?000---------00---?--11111-0101--10?0----1??1????01120?01?1001??-???1010011001100010010011020101?000100?001---------1010010011101000010-00111101-010010000-101?00---------0--------0-----???-0??-0-1?????-1?----??0-\
    10000--012?01-0?-0-0--??1202---?1-?21------?------0----?0--30----000--1?0?011101101-000---?--11011-0?00--?010----1?01000?01020011?110101-1?0?11?11?001????1011011102000100?100011?1---------1-00110111101100111000100100-0000??0010100-01---------0--------0-----???--??-0-1?????-01----1?0-\
    0-00????1??-??1??0-?1-01?0??-11?0?--100?11010??-20?----?--1?0----??11-000??1-??0-----10--0?--00101-0-??--00?0--?-???10???0??????01???0???????0???????????????--?0-???????0?0001???00101100000----1-10????????111001010?0?0000--10?1??????-??1-0?-?0?-------0-?---????-??-??-?????0??1010??10\
    0-100--00-?---?-?--------?1?300?00--0000000-0??-00110-----1-0----0010-0????1100----?010--0?--0000010-??0-0??0--?-0??0???????????0?????????????????0??????????--?0-????????????????00000110110????1--00?-???-01--11000-0--0-----0?00??0???--?-?0?-???-------?-0---???0-????--?????---0-0-??10\
    0-00????????00?????0?????11???-?1?000??-?--??-----10---?1--010000?00--???????--?-----00---?--?????-????--????????1??1?????????????????????????????????????????????????????????????01--1-----1010010?0???????01??00111010111100?0?10??1???-?-??----??---?--????????????????-??????-1?----???-\
    0-000--01?????10?0-000100???301?00--?00010000??-00??????--?-???????10????????????????????????0?????0???????0???-?0??0001000-0-0001-?-0000-0-0100?00??100000-?--00-?110000-0?00?00?000?????000----1-10????????????0??1????0-?---???????????-?--0?-????????????0???0---?-0?0?-0???????1010?210\
    0-100--0100?001010-00011010100-01-100??---???-----00---00--10----000--?????11??1001-000---?--?????-????--????????10?1?????????????????????????????????????????????????????????????1---------??????-?-???????010-0011111011111000?10??1???---------??---?--?????-????-?????-??????-1???????0-\
    0-000--01?????10?0-0??100???30-?00--001111000??111110--0--1-0----0010-?????10??----1010--1?--1100010-??0-?001{0 1}0?01?0100100000010111?00010-000000?00??10000???--010?110000-00001?0-000001?100?0?--1?1?????????????00?1??-?000---???????????-?--0?-????-???????0??-0??02??00?0????????11110211\
    0-00??????????1??0-?1-0100??-11?0?--100?11010??-20?----?--1?0----??11-000??1-??0-----10--0?--00101-0-??--00?0--?-???????????????0????????????????????????????--?0-?????????0?010??0000110000???--1-?0????????111001010?0?00-0--10??????1????--0?-???----?--?-?---????-??-??-?????0011010??10\
    0-00???0????00???0-00110?10100??1?00???---??0-----1??-???--?111?1??0--?????0???------0?---?--1????-????--????????10?1?????????????????????????????????????????????????????????????1---------11??????????????01??001110111010010??1???1???-?-?-----??---?--?????-??????????-??????-1?----???-\
    0-000--01211001100-0011001010--?1-101?----???-----1----?0--?11111000--?????0---------00---?--11011-0001--10?0--?-1??1???????????????????????????01????????????????????????????????1---------1110010?1???????010-00111101-0100100?001?11??---------??-------0-?---???--??-?-??????-1?----??0-\
    0-001101120-0110011100100110111100--010-{0 1}10000003?110--0-00-1100111101?????11?00---00110110101101100?100?00?11000101100?????????1????10???????0?0??00????????--???0??1??????????0?0011100-00?????1???1101000010-00000-0--0-----0?00??1???1010-10-00?00001000?00?0?0000??0{0 1}00?????10?1111??1-\
    1?10????1???1-0?-0-00?????0??--?1??01------?------0----?0--30------0--0????11??1001-000--0---????1-1?-0--1100----1?10??0?0?120001?11?10??-???0????????????0--0-11??200-000?100??0-1---------1-00110100111010011000000-0--0-----000-0-0-??-?-------??-------0-----???-???-0-??????-01----??--\
    1010?????????????????????????????????????????????????????-?????????????????1???11??-000--??--11011-0?00--??10----1?0??00?001200011111101-10001111110011000110101110200010101000101????????????????????????????????????????????????????????????-?-?????-----0???-?????-?0-0?100010-??----?1??\
    1010????12??1-1000-0--???20?---?1??01------??-----0----?0--?0----000--110??11??1101-000---?--11011-0000--?0?0----1??1000?0?12?011?1101??-??0?11?11????????1??10?110200010??1000?1?1---------1-0011010110100001100010010?-0?00??0000??0-01---------0?-------0-----???--??-0-??????-01----??--\
    0-000--0100?001?10-0000101013--?1?000?0---?00-----10---?1--?10000000--?????11??1000-000---?--11011-0?00--10?0--?-???1?????????????????????????????????????????????????????????????01--1-----1000010?????????01??0011101011110000?10??1???---------??-------0-----???--??-?-??????-1?----??0-\
    1010????1???1-???0----????0?---?1??01------??-----0----?0--?0----000--1?0??11??1101-000--??--11011-0?00--1010----1??1?00?011200011110111-110011111100110001111011??2000100010001111---------1-00110111101100111000000-0?-0---??00010-0-01---------0?-------0-----???--?0-0-111100-??----?1?-\
    0-00??????--?-??????--??-?--300?0?--001111100??111?10--0--1-0----??11-0????11??0---1010--1?--11???1????0-00?100011??1????????????????????????????????????????--?1?????????????????0000011100?0?--1????10????01??00001-0--001---1001?01?10--?1-0?-???-------??0-?-???0-??0?-??????1011111??11\
    0-00???????????????0--????--201?00--11111-?00??-10?----?--0?0-???0011-00?0010??0---1010--1?--11????????0-0??10000????????????????????????????????????????????--?1??????????0111?0?00001110?0????????01???????11000001-00-00??--100--?0-10-??1-0?--?--------?????-???0-??0?-??????10?1210??11\
    ??00????????00???0-001100101100?1?100??-?--??-----?10--?0---0----??0--?????0--??--?--?0--??--1?????????1???????-??0?1?????????????????????????????????????????????????????????????01--------10?0?10?0???????010-00111100-010010??10??1???-?------???-------?-??--?000?????-??????-1?----??0-\
    1?100--?12??1-0?-0----???-02---?1??01------0------0----?0--30----000--01010111?1101-000---?--??001-0?00--?100--?-1?10??0?0?1?0?01?1?-1???-???0?1?0????????1010-11?0200?0?0?100????1---------1-00110101111010011?0010010?-0101--0011100100---------0--------0-----???-???-?-1?????-0?----??--\
    0-??10-01?1?00?0?1111-01?11?10??00--01?-11?00010???0-?-????-??????1??0?????11?00--?00?1?0??0???????????0?????????1??1????????????????????????????????????????--???????????????????00111??-??????????????????01??00??0?0?-0--?????10??1???-000-10-???000??-??????????0?????-???????0?1111????\
    0-0?0--011????1??0-01-????1??00?00--001111000??000110--0--1-0----0010-0????10?????-1010--1?--1100010-??0-?00100001?0100100001010111000010-000000?00??100000----010?11000000?00??0-000001100000?--1-101??????????000?1-?0?001---1????????????1-0?-???-------?-00--0??02?000?0????????11110210\
    0-100--0101?001100-001100101?--01?000?--?--?------00---?0--20----00??-?????00--------10--??--?????-????0-???????????1?????????????????????????????????????????????????????????????00--1-----110100001???????010-0011111000100100?10101???---------??-------?-?---???-???-?-??????-1?----??0-\
    10?0????12????10?0-0??????0?---?1??0?------?------?0---??--?0----000--1??0011101001-000---?--11011-0???--??10----1?010?0?0012?010?11010?-??1?11?{0 1}1?00???0?11010?11020001000?000?0?1---------1-0????1?1101???0???001?1?101111000???????????--------?--------?-----???--??-0-??????-1?----??0-\
    0-0??????????????0-00000??1?10?000--01?-1100-??-0?110--1-00-1100-?11100????00??0----?11?0?00-11000100000????0----1??100??000100?1?1??00????0?0?000???????????--?1?02100?0??1000?1?00000110?0????????????????????????1????00000-????????????00-0?-???00001?-0??---???0????0?0????????120-??10\
    ???0????????????????????????310?00-??1?-11100??-1????????-1-??????????0??????????????????????????????????????????1?????????????01????????????????????????????--???????????????????0000011000?????????????????????0??1????001?0??????????????0?0?-????????????????????????????????-??1010??11\
    0-010--0120-011020-01-010100310001--010-01001000--111010-10-11001111000111111100---011110100111011001000100011010101100011101000100--101101010000111111110101--?1012011110111001000001100-000------0000-100-010-00000-0--0-----01101011101-0-?00-011000000000011000201000102000111001111111-\
    0-00???0100?001?00-0011101010--01?100?--?--?---0?-10---00--111111000--?????01--------00---?--1????-????--???0--?-???1?????????????????????????????????????????????????????????????01--------1110011?????????010-0011101011100100?10??1???---------??-------0-----???-???-?-??????-1?----??0?\
    ??0?????????1-???0-000???20?30??{0 1}00000??01?00??0-?110--?0-?-0--?-0010-0????10??----1?10--0?--?0?0010-?-0-????????0??0??????????-?????????????????????????????--?1??2?????????01???00?0110??0???????1000-1???010-00001-0--001---1?-???0???-??0?0?--??--??--?0????-????0???0-???????0?0-0-???-\
    0-000--0121?001100-0011001013--?1?000??-1--?------00---?0--210001000--?????0---------?0---?--?????-????1-???????????1?????????????????????????????????????????????????????????????1---------110100010???????010-00111110?111010??10??1???---------??-------0-----???-???-?-??????-1?----??0-\
    0-01???012?-011??0-01-000100311001--010-11001110-?011100-10-110010110001111111010100111101001110111010001000110101011010?1101000101-010???101?0?01?10???????????1?1??11???????????00011000000------0010-111-010-00000-0--0-----011011111?1-01100-1100000000000110?0001110002?????10011??1?1-\
    0-0110-112?-011020-01-010??0010001-0010-01001000--111010-10-11001?1100?1?1111100---011110100111011001000100011000101100011101000100--101101010000111111110100--01012011110111001000001100-000------0000-100-0???00?????????????0??????????00-10000110000?000001101020101000200011???1111111-\
    0-01111?1???011001001-0101101???00--01?-01001000???10--?-0?-1100111100?????11??1?10001101110111????0???000001000010?1010?1?????01?11?0?1????????0????????????--??????1????????????00111100000--?-1???1???????1??001?1000-010000??10??1???1?0--00-0??000??0000?????0000??0????????01?11111?1?\
    0-000--?1{0 2}?0??1010-000?11?01???????????-?-???----??0---??--?0--?-000-?????????????-??00??-?--?????-?????-?????????????????????????????????????????????????????????????????????????01-----?--1000?1111????????1??00111100?011001??10??1???-???????????????????????????????????????-1?----???-\
    1?10????12??1-0?-0-000?11201---?1?110------?------00---?0--?0----000--1???011??1101-000---?--11001-0?0?--1?10----1??110??00????01?11?10??-??????1?????????11?01?1??2000001??000???1---------1-0011010?10100001100010010?-0101??0010111101-?-------0--------0-----???--??-0-1?????-0?----??--\
    10100--012?0?01??0-001111?0?---?1?10?------?------00---?0--?0------0--?????110-1101-?00------?--?1?1???--1110----1??1000?00???001???01?????0?100??????????0-?0-????200-00??1?00?1?1---------1??001???111100?01??00100100-00000-1?11100???---------??-------0-----???-???-0-1?????-0?----??--\
    0-00???0????00??00-0011001010--01?101?--?--?------1----00--2112--000--?????0---------00---?--11011-0001--?0?0--?-1??1??????????01????1??????????01??????????????1????10?????1?????1---------1110010?1???????010-00111101-0100100?0-??1?0?-?-------??-------0-----???--??-?-???????1?----???-\
    0-?????????-01?0?1111-010110111101--010-010000103?110--?-00-1100111101??1??11??101000110111101101100?1?0000?1110011?10???010?10?1?1??1??????????0????????????--?1?02?1011???10??0?0011100-00?-???1??01101001010-00000-0--0-----??0-??1?1?0?1-010-00?000010000?0?0?0000??0?00?????10?1111??13\
    0-000--011?-??---------?----300?00--001101100??111?10--0--1-0--?-0011-0??0?110--?--1010--1?--1110010???0-?0?100011?010?1????????1????00???0??????????????????--?1?????????????????000-0111000???????0110???0?11000000-0--0-----10??0-????--?--0?-???-------?????-???0-??0?-??????1011110??11\
    0-00???012??00?100-0011001013--01?100---?--?------00---00--111111000--??0??11??10101010--0?--11011-01000-10?0--?-???1???????????????????????????????????????????1?0???????????????1---------1110011?1???????010-00111101-0100100?10??1???---------0?-------0-----???--??-?-??????-01----??0-\
    0-000--????????????0????????3???{0 1}000????01?00??0-?110--??-0-0-???0010?0????10??----1?10--0?--?000010-?-?-0?00----0??0?01?000000-?11--0010-00?????00??10010??---010?21000000000100-0000110000???00??100??????????000?1-?-?001---1????????????0-0?--0--------?-0---0??00?0-0-0????????0-0-?2?-\
    0-00???0????????????????????100?00-??1--?10000?0??????????????????????????????????????????????1????0????????0----?????0??0001000111?010?1??1?0100??001??1?0-?--010020001000010010???????????????????????????????????????????????????????????--??-????????????0???????????1?0????????1111????\
    0-10???01???001010-00001?1013--?1?10??--?--?------00---?0--?0----000--1????0---------0----?--110?1-0???--00??????1??1??????????0????0?????????????????????????????????????????????1---------1?????-10???????01??0011111011100{0 1}00010??1???-?-------??-------0-----???-?????-??????-1?----???-\
    0-011??01????????11110??????111101--01?-010000003??10--0-00-11001?11010????11??0---0?1101101011011001100??0011?1?111100010101100101?0111101010000010011111100--?10021101101110011000???????0????????????????????????0??-???????????????????1?010-0??00001000?0??0?0000?002?010110???11111113\
    0-00???0??????1??0-010?1?010300000-0001101000??00?110--0--0-0----0010?0????10??????1?1??-1???11????????????0100001?0100100001010111000010-000000?00??10?000----010?11000000000100-0000011000???????1?1??????????00??1?00-001?--???????????-?0-0?-???-----?-??0?--???-2?000?000000???1111?210\
    0-0?????1????0???0-00??1???1?--????????????????-???0---00-?310001000-??????110-1002-000?-??--1??11-0???--00???????????????????????????????????????????????????????????????????????1----?----1??001101???????0???00??1?1?1010?10????????????-????--??---?---0-?????????????-??????-1?----????\
    0-011??0????????????????????111?00--?1?-0?00000-???????????-???????10?????????????????????????1????0????????????-1?0100010?011?01111010110?0??00001001101?100--?100201?1?????????????????????????????????????????????????????--????????????0?-0--????????????0???000000??0?001010???1211021?\
    ??000--00-?????????01-???01?211?00?-00?101?10??-0?1??--?--0-0----????-0??????????????0??-????0???????????????????????????????????????????????????????????????--??????????????11???0000111??0????????????????0?????001-0?-011-00???-??0???-??1-0?--????????????????????????????????0?1010??10\
    0-000--010??1-00-0-0000?12013?-?1?10??--?--0------0??-???--01000?000???????0?------?-00--??--?????-????--???????????{0 2}?????????????????????????????????????????????????????????????1---------10??????1???????010-0011111011110010?10??1???---------??-------?----????-?????-??????-1?----??--\
    0-000--011??????????????????311?00--?00111?10??-0??-?-??-?0-????????0????????????????????????00????0???????00----1?1200??00-1-0001??-0000-0-01-1?0???10?00?----00-?110000-?001100-000???????????????????????????????1??0??01?--?????????????0?0?-????????????0???0??00?0-0?-????????1010?010\
    0-000--012?????????001?0010100-?10001?--1--?------1----?0--011101000--?????0---------00---?--11?11-0??0--???0--?-1??1???????????????????????????0?????????????????????????????????1-----?---111001?0????????010-0011101100100100?0-??1???-?-?-----??-------0-?---???????-?-??????-1?----???-\
    0-011100120-011001111-010110110101-?010-010000003?110?-0-00-1100111101?111011110---001101101011011001100000011100111100010101100101??111101011000010011111100--01002110110101001100011100-000----1-001101001?10-00000-0--0-----0?0-0-10100-1-010-01-00001000000?0000000000000001010111111113\
    0-01110?120-011001111001011011?101--01--010000003?110--0-00-1100111101?1?1011110---001101101011011001100000011110111100010101100101??111101010000010011?11100--?10021101101?10011000111000000------001101001010-00000-0--0-----010-?-1?1?001-010-01-00001000000?0?0000??0100?????10111111?13\
    0-100--012??1-00-0-0??01?201---?1?100---?--?--0---00---?0--0?0???00??-?????10--------00---?--?????-????--???????????1?????????????????????????????????????????????????????????????1---------??????-?????????01??00111100-1110010?10??1???---?-----??---?--??-?????????????-??????-??----??--\
    0-010--012?-011020-01-00010031?001--010-11001000??111001--0-1100?01100??11?11101010001101010011111?01??0000?1000010?1010111???0010???001??1?1???0-1001??1????--?1????1?11?????????001110?-000----1-0000-1??-?10-00000-0--0-----0?101011??1-0-100-00?000000001?-?0?000???0?0??????10?1110??1?\
    1?101???????1-1??0-0--01?-0?---?1??11------?-?----0--?-?0--?0----000--?????11101101-000---?--??001-0?0?--?010----1??1????0??????1?1??1???????????0?????????????????2?????1????????1---------1-00110101101000011000100100-0101??0?10111100---------??-------?---?????--???0-??????-01----???-\
    11100--?12?11-?????-??????0?---?1??0?------?------0?---??--?0----000--1101?110-1101-000------11011-0100--1010----1?01100?000200010111101-100011111100110001111011102000101010001011---------1-0011011?11111?011000100100-0??00?00--0-100?---------0?-------0---?-0??--?0-0-11001?-??----1??-\
    0-00????????--???0-0?????11?3???00--0??0000?0??-0?110--?--?-0--?-0010-0?????0--???-???0--?--?0???????????????????0??????????????0????????????????????????????--?0-????????????????0000011????????????0??????01??10001-0--0??---??0-??0-??-??-?0?-???-????-????????---?????--?????00?0-0-??10\
    0-000--010??001010-000???1013???1?000?--?--?------10---?1--?10000000--?????110-1001-000------?????-????--???0--?-???1?????????????????????????????????????????????????????????????01--1-----1110010?0???????010-0011111011111010?10??1???---?-----??-------?-?--????????-?-??????-1?----??0-\
    0-000--01201??1000-00110010?3--?1?10?---?--?------?0---??--1?????000???????110-10101010--0---11011-0??00-?0?0--?-?????????????????????????????????????????????????????????????????1---------1110011?????????01??00111?01-0100100?1???1???---?-----??-------0-?---???????-?-??????-??----???-\
    0-0110-112?-011021001-01010001?001--010-0?0011100??11100-10-1100111100??111111010100111101001110110010001000110101011010?1101000101-?1011?1??00?01?101???????--?101201?1????1?????0001100-000----1-000????1-010-00000-0--0-----??10??1???010110001?00000?000001?0?00011?0002?????10011111?10\
    0-000--01?1?001100-00110010100-?1?001---1--?------1----?0--?11100000--?????0---------00------11?11-0???--10??????1??1????????????????????????????1????????????????????????????????1---------111001001???????01??0011101101100100?0-??1???---------??-------0----????-???-?-??????-??----??0-\
    0-011111120???100101000????001??01--01?-0?0010?0???10--1-0?-???????????????11001?10001101110111????0???00000100001001010?11011?01111?0011?????0?0?1001??1?100--0100201?1?0????????001?????000???-1?00110?????????01?10?0?01000????????????00-1?00???0000?0?010????00000?00?0?????01111??1?1?\
    0-10???0????001??0-?1-???010300?0?--0000000?0?--00?10-----1-0----??10-0????????--?-?-10--0---??????????0-???0--?-0??0???????????0????????????????????????????--?0-????????????????00000110110????1--00?-???-0?--11100?0?-0--?--0?0-??0???-??--0?--??-------?-?---???0???-?-??????---0-0-??10\
    ??000--01?00001110-00011010130??1?000---1--0------10---?0--01?00000???1????11??100?-000------11011-0000--?0?0----1??10?0??0??????????0?????1?0000??????????????????????????000????01--------100001010???????010-0011101011110000?10??1???---------??------??---?-???-???-?-??????-1?----??0-\
    1010????????????????????????-????????????????---?-???-?????????????????????11?????-?00?--?---11011-0???--?0?0----1?????0?00120001??10101-1?0?101011001?00?10010011020101?000000?0???????????????????????????????????????????????????????????------??-------0---?-???-???-0?1??0??-??----????\
    0?00???????????????0?????01?-01?00--1???11010??-2??----0--1?0----0011-0??0?1-0-0-----10--00--00?0?-????--???0--?-????????????????????????????????????????????--?0-????????????????00001-0??0?0?--1-??????????11100101000-011000??11100-11-??0-0?-???-------0-?---???????-?--?????-1?1010??12\
    ???????????????????????????????????????????????????0------??????????-??????11??--?-??10--?---11???-0?0?1-0??0----?-?00?0?00110001?100?0????0?0???0?0-1??1?0--1-?10?200000?10100?0???????????????????????????????????????????????????????????????????-------0-??--???????-0??????????----????\
    0-0010-01{1 2}0???100??0????0???301?00-00001100{0 1}0??-2?110--0--0-????-0010???????0??????1-?0--1?-?0000010??-??0?0?????0?010?100001010111?-0000-000010100--101000--?-010?11000000010????0000?11?000???????00???????????01?10?0?00100-???????????-??-0?-???-???????-0??-0??00?0?0?001000???1010?2?2\
    0-0111111????????1011-01????01?001--01?-0?0010?0???10--0-1?-???????????????11??1?100?11?0100??1????0???0100?110001??1010?11011?01111?10????0?0?00??0?????????--?1?12011?00?110010?001?1???000------??10-?????????0??0??-??????????????????0011?00???0100?1?0?0??????010?00?2????????11??1?1?\
    1110??????????1-10-000010???-???1?1??------?------?0---??--??????00????????11??110?-000------11?11-0?00--??10----1????00?000200011111101-100011111?001??00111101110200010001000101??---?-?--????1?????????????????1??1????111??????????0??--------??-------0-----???--?0-0-1?????-??----???-\
    0-000--01201001100-001100100---?1?100---?--?------00---?0--00----000--?????0-------?-10--0---11001-0-00?-?0??????1??1?????????????????????????????????????????????????????????????1---------100001001???????010-00111000-0110100?10??1???---------??-------0----????-?????-??????-1?----??--\
    1010???01???1-1??0-0--???-0----?1??01------?------0----?0--?0----000--1?0??11??1101-000------01001-0?0?--1010----1?01000?00120001?110101--?0?01?-0?001??????11111??200000?11000?0?1---------1-0011010?101100011000100100?0101??0010111100-?-------0?-------1-----???--??-0-1?????-01----??--\
    0-00?????????????0-0?????1013???1?000---?--?------?0---??--?1?000000--?????11??1?0?-000------?????-?????-?????????????????????????????????????????????????????????????????????????01-----?--10?001??1???????01??001110101111001??10??1???-?-?-----??---?--??-???-?????????-??????-??----??0-\
    0-00???01???--?????0????????300?0?--0000?00?0??-0?110-----1-0----001??0???????????-???0--0--?????????????????????0??????????????0????????????????????????????--?0-????????????????0000011011?????1??????????????10??1??-?001--???????????-??0-0?-????????-??????????0??????-????????0-0-??10\
    0-0?111112??????????????????011?00-?01--01000000--?????????-???????????????11?00---0011???0????????????0?00??????1???????0?01????????????0????????1??11?11100--?10020??1?0????????????????????????????????????????????????????????????????01--?00????00??0?0?0???????????1?0?0010???1111???-\
    0-0110-112??????21011-010??00?1001-001--1?000?00--?10--??1--1100111??0?????1110????01111010?111??100???01000110{0 1}01011000?0101000100-0101101010000010011010100--?10120101101110010000011?00000------0010-?????????0??0?????????????????????1011000???0000?000011?0100010?00?2000?1???11??111-\
    0-0110-112????1?21001-010???01??01-001--01000020--????????0-1100111100?????1110????01111?10?11101100?0001000110001011010?1101000100-01011010101000?101??1???????10?201111??110??00000?1??00??????????????????????0????????????????????????10-10001???000?0000?1?0000011101??????????11111?1-\
    0-0110-112??????2???????????01??01-?01--11000?20--?????????-???????????????11100---10111-100-110?100?000-00?1101010?1000?0101?0010???10???10????????????????????1????1?1?0????????????????????????????????????????????????????????????????1011011????11100-00?0?0101010?0???????????11??1?1-\
    0-0110-112?-011020-01-00010001?001-001--{0 1}1000000--011100--0-1100101100?????11100---1011?-?00-11-?101--00-00011-001-10000?0001-0-10---1010-1??000-11--110100--10010020000000110010-00011000000------00?0-?11-010-00000-0--------011011111?110010111??111100-0?1??11120200100?0001?10?1111111-\
    0-01???????-0110?0-01-000100{1 3}11001-001--1-001110--?11000--0-1100-01100????111?00---00111-?00011111?0?0000000110001011000?1001000101001011?1010000110011010???--01010011000??1??10-0001100??0?????????????????10-00000-0--------0010??1?111-00000-01011000111?0??0???10000012????010?11111?1-\
    0-01???????-?110?0-01-000100{1 3}1?000-001--1-?01120--111000--0-1100-?1100?????11?00---0011?-?0001??11?????0?00?11?001??0?????????????????????????????????????????????????????????????0011100000????????????????010-00000-0--------??10??1?1?1-00-00-0??11000111????????1???0?1???????0?1111??1-\
    0-0110-112?-011021001-00011001?000-001--1-0000?0--?11???-?0-11001??10?0????10--------11???00-11-?101--00-01?1100-10?0000?000?-?-1?---1?1?????0??-??--???????????1??2000?0??0100?0?0001100000????????????????0????00?0????????????10???????1?0-?11????11100?0????1?1202??100?????????1111??1-\
    0-01????????011??0-01-0001?0{1 3}1??0?-00?????????????11????????1??0???10??????11??10100?111??0?01??110????0?00?????????1???????????1???????????????????????????????1??????????????????????????????????????????????????0?????????????????11??1??????-?1??10????1????????1?????1???????????????1?\
    0-01???????????????????????????????????????????????????????????????????????????????????????????????0???????01101-1?1100010101100101111111010100000100111111000-?10021101100?100110????????????????????????????????????????????????????????????????????????????????????0002?010110???????11??\
    0-01????????????????????????110?01-001--1-0000?1???10--0?0????????????????????????????1?1????1?01100?10????01101-1?1???01010110010110111101010000010011111100--?10021101100?1001100?1?1???00?????????????????????0??????????????????????????00?0-???0????????0?????????002?010110?????????1?\
    0-01??????????1?21111-000??0110101-001--0-000000--110-00-00-110011110000?1011110---0011?1?0101?011001100?00011?000?1???0?0101100101101111010?0?00010011111100--?1002110110?0100110001?1???00?????????????????????0???????0?????0???????????1-010-01-00001000?0??0???????00?000010???1111??1-\
    0-01????????????????????????010001--0???1-011000???????????-???????????????111010100?11?100??11????0?????000100001001010?1?11000100-?001001?1?1?0?10011010100--?1012011110????0100?????????????????????????????????????????????????????????001?0??1?00??????100??10000?00-?201000???1111111?\
    0-01????????????????????????010?0?--????0-011??0???????????-???????????????11??10100?111???0???????0???000001000010?1010?1???????1??000????0??0?2??0?????????-????????????????????00?1????0?0-?????00110????????????????????????????????????-????????000100010????0000??0???????????????1?1?\
    0-0???????????1??1010001011?1?????--??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????0011110????????????????????100001?1000-010000??1???????????????????????????????????????????????01???????1?\
    0-011??1????????????????????110?0?--?10-????10?00-?????????-?????????????????????????????????????????????????????????????1?010?????????11??0?0????1??11010100-??1-12010100?1?00100?????????????????????????????????????????????????????????0?1?0?????????????0?????????????0?0000???11????10\
    0-11???0????????????????????3???0?--??01??????????????????0-?????????????????????????????????????????????????????????????0????????????01?-????????0??10???0--??0????11?0000?00?0??????????????????????????????????????????????????????????????????????????????????????????????????????????1?;";
    
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
//    mpl_matrix_set_gap_handle(GAP_MISSING, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    len = mpl_fullpass_parsimony(t);

    if (len != 379) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
//    if (len != 936) {
//        ++failn;
//        pfail;
//    }
//    else {
//        ppass;
//    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}


int test_fullpass_with_multiple_inapplics (void)
{
    theader("Test full-pass with multiple characters with  data");
    
    int failn = 0;
    
    long ntax = 12;
    long nchar = 8;
    double expected[] = {5.0, 2.0, 3.0, 2.0, 1.0, 5.0, 5.0, 2.0};
    double explen = 0.0;
    
    long i = 0;
    for (i = 0; i < nchar; ++i) {
        explen = explen + expected[i];
    }
    
    char *rawmatrix =
    "2111-001\
     3-11-11?\
     --0----?\
     --0-----\
     11--1---\
     ?1--1-1?\
     ?1--100?\
     -1--111-\
     --1--00-\
     0-11-111\
     3-00-000\
     21001110;";
    
    char* newick = "((((((1,2),3),4),5),6),(7,(8,(9,(10,(11,12))))));";
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    len = mpl_fullpass_parsimony(t);
    
    if (len != explen) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}

int test_multiple_small_matrices (void)
{
    theader("Test multiple small matrices");
    
    int failn = 0;
    
    int ntax = 12;
    int nchar = 1;
    //                       111111111122222
    //              123456789012345678901234
    char *rawmatrices[] =
    {
        (char*)"23--1??--032;", // 0
        (char*)"1---1111---1;", // 1
        (char*)"1100----1100;", // 2
        (char*)"11-------100;", // 3
        (char*)"----1111---1;", // 4
        (char*)"01----010101;", // 5
        (char*)"01---1010101;", // 6
        (char*)"1??--??--100;", // 7
        (char*)"21--3??--032;", // 8
        (char*)"11--1??--111;", // 9
        (char*)"11--1000001-;", // 10
        (char*)"01------0101;", // 11
        (char*)"110--?---100;", // 12
        (char*)"11--1??--111;", // 13
        (char*)"210--100--21;", // 14
        (char*)"????----1???;", // 15
        (char*)"23--1----032;", // 16
        (char*)"1----1----1-;", // 17
        (char*)"-1-1-1--1-1-;", // 18
        (char*)"23--1??--032;", // 19
        (char*)"--------0101;", // 20
        (char*)"10101-----01;", // 21
        (char*)"011--?--0011;", // 22
        (char*)"110--??--100;", // 23
        (char*)"11--1000001-;", // 24
        (char*)"21--1----012;", // 25
        (char*)"11----111111;", // 26
        (char*)"10101-----01;", // 27
        (char*)"210210------;", // 28
        (char*)"----1111----;", // 29
        (char*)"230--??1--32;", // 30
        (char*)"023--??1--32;", // 31
        (char*)"023-???1--32;", // 32
        (char*)"23--1?1--023;", // 33
        (char*)"----1010----;", // 34
        (char*)"------11---1;", // 35
        (char*)"10----11---1;", // 36
        (char*)"320--??3--21;", // 37
        (char*)"-------1----;", // 38
        (char*)"0--11-111111;", // 39
    };
    
    int nummatrices = 40;
    
    double expected[] = {5, 2, 3, 2, 1, 5, 5, 2, 5, 2, 2, 4, 3, 2, 5, 0, 5, 2, 4, 5, 2, 4, 3, 3, 2, 5, 1, 4, 4, 0, 5, 5, 4, 5, 2, 1, 3, 5, 0, 1};
    
    char *newick = "((((((1,2),3),4),5),6),(7,(8,(9,(10,(11,12))))));";
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    int i = 0;
    
    for (i = 0; i < nummatrices; ++i) {
        double len = 0.0;
        mpl_matrix* m = mpl_matrix_new();
        mpl_matrix_set_nrows(ntax, m);
        mpl_matrix_set_ncols(nchar, m);
        mpl_matrix_attach_rawdata(rawmatrices[i], m);
        mpl_matrix_apply_data(m);
        mpl_init_parsimony(m);
        
        if (i == 32) {
//            printf("check\n");
        }
        len = mpl_fullpass_parsimony(t);
        
        if (len != expected[i]) {
            ++failn;
            pfail;
        }
        else {
            ppass;
        }
        
        mpl_matrix_delete(&m);
    }
    
    return failn;
}


int test_find_char_by_char_mismatches (void)
{
    theader("Find mismatches between");
    
    int failn = 0;
    
    long ntax = 47;
    long nchar = 134;
    
    long i =  0;
    
    char *rawmatrix = "0000-0-???01001?1?000??--00-000------0-0-----?---------000?100?0-0000000-00?0-----010-000--00-0000--------?--0----0-0??---??0-?----0??\
    000100010??0110?0?10000--00-000----0-0-0-----?---------000000000-0000000-00?0-----010-000--00-?0100000-0?1?--0-1001?00-000?0?-00---00?\
    000120011001001100111??-0?10001121?0-0-?0-----001110010?011?1??01?0111??0111101?011110?011-11011111---0-1{12}0101001110100001111100100011\
    10012000?000?0-10?1?1??-0?0-000----0-0-?11110-0011000001001?10?000111010110?111?111?101111-01010001---0-11-001011110111001100100000000\
    0100-00?--?--0?00?0-0000100-0-0----100-0?----?0100-0??0?0?0?0??????0?????0??????????????0?????????000010?0???1--001-0--110000-00---010\
    000??0???????11???100??-0?1011100000-0-??-?---00??????????1?1?????????????????????????????-???????01-10-1201010??01?10?00?111011110001\
    0001?0??00010???0?0-?000?10-1-?????10??????????????????0?001000000000000-0000100?0100-000-100-00?000????11-00101?01?????01??1??0??????\
    0101000100?1101100100??-0?11000----0-0-011100-00??????????1?1?????????????????????????????-???????1---0-?2????-??-1?10000?111111111001\
    00?1?0?10001????0?0-0011110-0-0----110-010--0?0100-0??001010100001010010-0000000?01???0012100-0010000011?10?-1?1??1?????0?0?1??000????\
    000??001?010100?1?0-11-0010-1-?----110-112---?0100-0??0?0????????????0????0??????0??????0-1???????000110?1??-1-??01?1110011010000-01?0\
    0?0??0???0010?1???10???-?110??111?10-0-?0-----?0??????????1?1?????????????????????????????-???????1---0-121???????1?10?00?111010100001\
    00012001100100110?111??-0?1000111110-0-?0-----001110000?0?1?1???????????????????01????????-???????1---0-1211010??11?10000?111100100011\
    0001201101010110110-01-110101-1100110111110-001111-?11??101?10?????11????1????0?0??????????1??????00110-?0???1????1010000?000-00---011\
    110?????????????0??????-????????????????1111???0110?0001?110???000011010100011111110111111?0110000????????????????????????????????????\
    11012001000??021??111??-0?11000----0-0-?11110-001100000?0?1?10?000111????1???11?11??1??111-01??0101---0-11-00101101?10000?100000?00000\
    0001000??00010110?10000-0?1011100000-0-011100-0011??000?0???1?????????????????????????????-???????01-10-1200010??01?10?00?111011110001\
    000??00??????0??0?0-0011110?0-0----110-0110-0101????????1?1?1????????????0????????????0???????????000011?10?-1????1?10?00?001-0001-111\
    ??0??001?00100110?100??-1?10000----0-0-0???---0?????????????1?????????????????????????????-???????01-10-120?010??01?1?000?111100100001\
    010??0??0110111???0-01-101??1????????100110-001???????????1?1?????????????????????????????????????00110-??????????1?10000??00-00---?01\
    00?110?1?0??????0?0-0011110-0-0----100-010--0-0100-0???01010100001010010-0001000?0100-0012100-00?0000010010?-1-1101????0010?1-?001-1??\
    01?1?0011001001??0110??-0?12100----??0-?0---0-01????????????1?????????????????????????????-???????00110-11101000?01?100001111110100001\
    1?0??0010???????0?10???-0?????0----0-0-?11110-001?????0101??10?0001010???0??111?11?011?111-01000?0???-????????????1????00???1???11????\
    00010001?0011011?0100??-0?1000111110-0-?11100-00????????0???1?????????????????????????????-???????0-110-1211010???1?10000?111011100001\
    0001200110010011??100??0011210100010-0-?0-----00??????1?????1?????????????????????????????-???????1---0-11001001?01?10000?111111110?01\
    1101200??00010210?110??-0??-000----0-0-?11100-00?1??0?01011?11?00?0110??-???0???1??011?011-00??0?01---0-11-001011010101000100100101001\
    000??00??001001100111??-0?10001121?0-0-?0-----001110010?011?1?????011????11?????01??????11-1?????11---0-1211010??11?10000?111100100011\
    ?????01?01101110110-01-110101-11001101111110101111-?1???1?1?10?010?111???11?????0??????010011????100110-?1-??1??101110000?000-00---?11\
    000??0???0010011?0100??-0?1?00110110-0-?1110110111?1000?0???1???????????????????????????1?-???????1---0-1211011??11?10000?111100100001\
    010??001????1??????????-??????0??-?0-????????-??1?????????????????????????????????????????-???????1---0-?0????-???1?10?00?11111110?001\
    001??0????????????0-?1-1???????????????1???????????????0?01010101?01101?01??1?000?1?100011?11?????????????????????????????????????????\
    00?110??????????1?0-?000?10-1-??????0??1???????????????00?1100?000000000-000?1-1?0100-000-100-?00000??????????????1?????????1???01????\
    000??00???0?0?11??101??-0110?0111110-0-?0-----0011????0?0?1?1???????????????????0?????????-???????1---0-111101?0??1?10000?111010100011\
    0011201101101110110-01-110101-1100110111110-001111-1100010111010100111110111111?00111000100110111100110-01---1-01011100001000-00---011\
    0101200000?01021??110??-0?0-00?0?????0-?1?----00????????????1?????????????????????????????????????1---0-?0????-??-1?10?00?111101110001\
    0011201100100?10?00-01-111101-1100?10101111010111101????101110111001001-?1111???011????01?011??1??00110-01---1-0001-100001000-00---001\
    1001200??????0????1????-0?????0----0-0-?11110-00110100010010?1?000011010100011111110111111-01100001---0-11-00101?11?10100?100?00??10-1\
    0?0??00100???01???100??-0?1011100000-0-011100-00????????0???1?????????????????????????????-???????01-10-1201010??01?10000?111111111001\
    000120?100010?1???10???-0??????????0????11101101?1???00???????????????????????????????????-???????1---0-1211011???1?10?00?111?00100001\
    0011211101101010000-01-110101-110?1101011110101111010000101110?110011011?111101?0111???010011??10100110-01---1-0001-100001000-00---?01\
    0101?0011011001???101??-011000111010-0-00-----00110???0???1?1????????????????????1????????-???????1---0-12110000?11?10?00?111011100011\
    001??1?????0??????0-01-?10???-?????????1111?101???????00101?10?110010011?1??1???0?11100010?11?????00?????11??1???01?????0?1?10?0100???\
    010??001?0???100??0-00??100?0-0?---100-00---??0?????????0?0?0??????0????????????????????0?????????0?0010?0???1--00?-0--11??00?00---010\
    ?00??00??00110110?100??-0110001?000?????11100-0011?0000?0?1?10??0???0????0???0000???????????????10011-0-11000101?01?10000?111011110001\
    110?????????????0??????-??????????????????????????0??????11????00001101?110?11010110101111?11?0?10??????1?????????????????????????????\
    010??0???????00?1?0-11-0010-1-0----110-112---?010?-?????0????????????????????????0??????0-1???????00011???0?-1-???1?11100?101000110?00\
    110??0?1-0001???0?11???-????????????????1111?0?0110??001?11??1?000011010100011111110111111-0100000????????????????????????1??1??11????\
    0001200110010011??110??-0?12000----0-0-0110-0?0101-0001???1?1????????????????????0????????-???????1---0-11000100?11?10000?111000110001;";
//    "0000000000     0000000000      000---0000 000-000000 0000000000 000-0-0000 0000000000 00000--000 0000000000 0000?\
//     11-1012100     1120200001      001---0000 100-1--100 0100000110 1010320010 0000101000 01000--303 0000000000 0010?\
//     ??????????     ??????????      ??30--0010 ??0-?????? ??1-?-??10 0?0-??1?-- ????0?00?? 10??1112?? ????100111 -0-1?\
//     00??0?????     ??????????      ??3111100? ?????????? ??011100?? 0???????11 ?1???????? 10?????2?? ????1?1-1? ?????\
//     000?0?????     ??11??0111      1030--???1 010-???0?? ??1---0-10 010-3?00-- ??010?000? ?0??111?1- ?0?111011? ???1?\
//     11-1012010     11212?0001      002---0001 100-010100 1100000110 1010320010 0000101010 01000--103 1000000000 0000?\
//     00?100(02)???  01?1(23)0???1   0?0---00?0 0010002?00 1100000001 000-31-010 ????-?30?0 00000--01- 0???00?000 0100?\
//     1011023111     112131???1      100---0000 00101--200 0100001010 00103011?0 1-1-010011 01010?-11- 10??00?0?0 0010?\
//     ??????????     ???????0??      ??3000?10? 010-0100?0 1100-0--10 0011300?10 ????0????0 010110021- 1???100110 1000?\
//     1011023110     1111311001      110---0000 000-1---00 0100001010 000-301110 1-1-013110 01010--11- 0010000000 00100\
//     ??????????     ??????0???      ??3000?1?0 ??0-010?1? 1100100?10 0?11??0?00 ????0??0?0 00111002?? ????100110 10001\
//     ??????????     ??????0001      ??3101?100 ????0????? ?100110010 0011??0?01 0100?????? 00??1002?? ??1?10???? ??001\
//     ??????????     ??2????11?      ????--???? ?????????? ??1-?-??1? ????????-- ?????0?00? 10?????2?? ???110011? ???10\
//     11-11?301?     1111(23)?0010   002---0000 0011012101 1100000111 001011-010 ?0001?0110 00000--?02 1?00000000 01001\
//     11-11?3001     2120000000      001---0000 0011002101 1100000101 000-11-000 0000100100 01000--101 110?000000 00000\
//     0011012?10     11?12??011      002---0000 1010002?00 1100000?10 1010??1??0 ??001?10?0 0100??-??? 1??0?????? ?0000\
//     1001??30??     112???0010      01?---0000 000-1--201 1100000111 000-2?-010 0000102110 01000--002 1?00000000 00000\
//     ??????????     ???????11?      ??30--0010 010-?????? ?11-?-??10 010-3010-- 0001?00000 10?????2?? ????10011? ?0-10\
//     0???0?1??1     ?0?1??00??      ??311111?? 010-0100?0 1100110010 0011??0?01 ??????0??0 0011???21- 101?1001(01)0 10001\
//     00000?1011     1011300001      1030000100 010-010010 1100100010 001?300010 0000000001 0{01}1110021- 101110?101 -0001\
//     0010000010     1011101000      110---0-00 0010011000 0100001010 0010301110 0?0?00?0?1 01010--11- 0?1?000000 00000\
//     00000?1?1?     ?0113?0001      1031111101 010-01?0?0 ??01110010 0?0-300001 0100?0?0?? 10?110(01)21- ?011111-10 10?11\
//     ?00?????1?     1?213?01?1      ????--0011 ?????????? ??1-?-??10 010-??0?-- ??0??0000? ?0???????? ?????????? ????0\
//     11-11?3???     1?2???0000      00?---0000 0011011101 1100000111 001011-010 0000100110 00000--002 11??000000 01000\
//     00?00000?0     1021100000      002---0000 10111--100 1000000110 1010320010 00001000?0 01000--100 10??00?000 00000\
//     ??????????     ??????????      ??30--???? ?????????? ??1-?????0 ?????????? ??0????0?? ?????????? ?????????? ????0\
//     ??????????     ???????1?1      ??3000?0?1 ????010??? ?1001???10 0011??0??0 00??0??0?0 00??11021- 1??1100111 -0001\
//     ??????????     ??????????      ?????????? ?????????? ?100?????? ???????0?0 00??????0? 00?????21- ???1100111 ---1?;";
    
   
    char* newick = "(1,(2,((7,(31,(((47,(((21,24),((((11,((12,(3,26)),(40,32))),(38,28)),23),((((16,(6,37)),(18,(29,8))),43),((30,(41,((27,(13,33)),(39,35)))),19)))),(34,(44,(22,((4,15),(25,(46,(14,36))))))))),(10,45)),(20,(9,17))))),(5,42))));";
//    "(1,(7,(((25,(16,(2,6))),(15,(17,(14,24)))),((9,((11,(12,(19,((26,((3,(5,(23,(13,18)))),28)),(4,22))))),(20,27))),(21,(8,10))))));";
//    "(1,(7,((((16,(2,6)),(25,((14,24),(15,17)))),(21,(8,10))),(20,(11,(9,(12,(19,((28,(27,(26,((5,(3,18)),(13,23))))),(4,22))))))))));"; //215
//    "(1,(7,((((16,(2,6)),(25,((14,24),(15,17)))),(21,(8,10))),((28,(((3,13),(18,26)),(5,23))),(27,(20,(((4,22),(12,19)),(9,11))))))));"; // 212
    //    "((7,(((25,(16,(2,6))),(15,(17,(14,24)))),((21,(8,10)),(9,((11,(12,(19,(4,22)))),(20,(27,(28,((3,18),(26,(5,(13,23)))))))))))),1);"; // 201
    
    mpl_matrix* m = mpl_matrix_new();
    mpl_matrix_set_nrows(ntax, m);
    mpl_matrix_set_ncols(nchar, m);
    mpl_matrix_attach_rawdata(rawmatrix, m);
    mpl_matrix_apply_data(m);
    
    mpl_tree* t = mpl_new_tree(ntax);
    mpl_topol top;
    top.num_taxa = 1;
    top.edges = NULL;
    mpl_topol_init(ntax, &top);
    mpl_newick_rdr rdr;
    mpl_newick_rdr_init(ntax, &rdr);
    mpl_newick_read(newick, &top, &rdr);
    
    mpl_tree_read_topol(t, &top);
    
    mpl_tree_traverse(t);
    
    double len = 0.0;
    
    mpl_init_parsimony(m);
    
    reset_temporary_changebuf();
    
    len = mpl_fullpass_parsimony(t);
    
   
        for (i = 0; i < nchar; ++i) {
            printf("%li, ", m->cbufs[MPL_DISCR_T].charchanges[i]);
        }
        printf("\n");
    
    if (len != 343) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    double sum = 0.0;
    double expectedvals[] = {1, 9, 2, 2, 4, 2, 1, 2, 3, 2, 4, 6, 8, 5, 3, 2, 4, 1, 3, 3, 2, 3, 3, 3, 6, 3, 3, 1, 3, 3, 1, 4, 1, 1, 3, 1, 2, 2, 1, 2, 4, 1, 3, 1, 1, 1, 2, 2, 1, 2, 2, 4, 2, 1, 1, 4, 1, 1, 3, 3, 2, 1, 2, 1, 2, 1, 1, 2, 2, 2, 2, 2, 1, 5, 2, 5, 1, 2, 7, 3, 2, 1, 1, 2, 1, 1, 2, 2, 3, 4, 5, 6, 2, 4, 3, 5, 1, 3, 3, 2, 2, 3, 2, 1, 3, 1, 3, 4, 2, 3, 3, 1, 1, 4, 2, 2, 1, 1, 3, 1, 1, 1, 4, 2, 2, 2, 4, 4, 2, 3, 7, 3, 8, 3};
    
//    {3, 3, 4, 1, 2, 4, 2, 3, 3, 2, 4, 5, 3, 5, 1, 1, 2,
//        4, 4, 1, 3, 4, 2, 4, 1, 5, 1, 1, 5, 4, 3, 1, 1, 3, 2, 2, 1, 1, 1, 2, 2,
//        1, 1, 5, 3, 2, 1, 1, 2, 1, 1, 1, 1, 4, 2, 3, 3, 2, 3, 1, 1, 1, 4, 2, 4,
//        1, 1, 1, 1, 2, 1, 1, 2, 2, 2, 1, 3, 2, 2, 1, 1, 2, 3, 5, 1, 1, 1, 4, 4,
//        2, 2, 1, 3, 1, 2};
    
    for (i = 0; i < nchar; ++i) {
        sum += expectedvals[i];
    }
    
    if (len != sum) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    mpl_node* site = NULL;
    mpl_node* clip = t->nodes[22].anc->anc; //t->nodes[27];
    site = mpl_node_get_sib(clip);
    mpl_node_bin_clip(clip);

    
    reset_temporary_changebuf();
    double sttlen = 0.0;
    sttlen = mpl_fullpass_parsimony(t);
    double srclen = 0.0;
    srclen = mpl_fullpass_subtree(clip, t);
    
    for (i = 0; i < nchar; ++i) {
        printf("%li, ", get_temp_change(i));
    }
    printf("\n");
//    for (i = 0; i < ntax; ++i) {
//        printf("%li\t\t%li\t\t\t%li\n", m->cbufs[MPL_DISCR_T].dnset[i][35], m->cbufs[MPL_DISCR_T].dnset[i][57], m->cbufs[MPL_DISCR_T].dnset[i][89]);
//    }
    
//        for (i = 0; i < nchar; ++i) {
//            printf("%li, ", m->cbufs[MPL_DISCR_T].charchanges[i]);
//        }
//        printf("\n");
    
//    reset_temporary_changebuf();
    mpl_src_root_parsimony(clip);
    double reconnectlen = 0.0;
    mpl_node_bin_connect(NULL, site, clip);
    reconnectlen = mpl_score_try_parsimony(-1.0, -1.0, clip, site, t);
    mpl_node_bin_clip(clip);
    
    for (i = 0; i < nchar; ++i) {
        printf("%li, ", get_temp_change(i));
    }
    printf("\n");
    
    if (len != (reconnectlen + sttlen + srclen)) {
        ++failn;
        pfail;
    }
    else {
        ppass;
    }
    
    double afterclips[] = {3, 3, 4, 1, 2, 4, 2, 3, 3, 2, 4, 5, 3, 5, 1, 1, 2, 4,
        4, 1, 3, 4, 2, 4, 1, 5, 1, 1, 5, 4, 3, 1, 1, 3, 2, 1, 1, 1, 1, 2, 2, 1,
        1, 5, 3, 2, 1, 1, 2, 1, 1, 1, 1, 4, 2, 3, 3, 1, 3, 1, 1, 1, 4, 2, 4, 1,
        1, 1, 1, 2, 1, 1, 2, 2, 2, 1, 3, 2, 2, 1, 1, 2, 3, 5, 1, 1, 1, 4, 4, 1,
        2, 1, 3, 1, 2};
    
    double reclipped[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 1, 3, 3, 2, 2, 3, 2, 1, 3, 1, 3, 4, 2, 3, 3, 1, 1, 4, 2, 2, 1, 1, 3, 1, 1, 1, 4, 2, 2, 2, 4, 4, 2, 3, 7, 3, 7, 3};
    
    for (i = 95; i < nchar; ++i) {
        if (reclipped[i] != expectedvals[i]) {
            printf("Mismatch at char %li\n", i);
            printf("Found: %f; expected: %f\n", reclipped[i], expectedvals[i]);
        }
    }
    
    int chgsbuf[nchar];
    int nchgs = 0;
    int j = 0;
    
    for (i = 0; i < nchar; ++i) {
        if (expectedvals[i] != afterclips[i]) {
            chgsbuf[nchgs] = expectedvals[i];
            ++nchgs;
            printf("%li ", i);
        }
    }
    printf("\n");
    
    for (j = 0; j < nchgs ; ++j) {
        printf("%i ", chgsbuf[j]);
    }
    printf("\n");
    
    double score = 0.0;
    double oldnascore = 0.0;
    double scorerecall = 0.0;
   
    score = mpl_parsim_local_check(-1.0, -1.0, t->nodes[27].mem_index, site->mem_index, site->anc->mem_index, t->base->mem_index, m);
    scorerecall = mpl_parsim_get_score_recall(m);
    
    score -= scorerecall;
    score += mpl_fullpass_parsimony_na_only(10000000, site->anc, t);
    
    mpl_matrix_delete(&m);
    mpl_delete_tree(&t);
    
    return failn;
}
